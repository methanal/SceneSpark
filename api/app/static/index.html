<!DOCTYPE html>
<html>
<head>
    <title>视频上传与处理</title>
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <style>
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
        }
        .section {
            margin: 10px;
            width: 80%;
        }
        #videoPreview {
            display: none;
            max-width: 100%;  /* 限制视频最大宽度 */
            max-height: 500px; /* 限制视频最大高度 */
        }
        video {
            max-width: 100%;  /* 限制视频最大宽度 */
            max-height: 500px; /* 限制视频最大高度 */
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="section">
            <label for="fileInput">选择视频文件（多选；按剧情的先后来选择上传。）：</label>
            <input type="file" id="fileInput" multiple>
        </div>
        <div class="section">
            <label for="textInput">提取关键字幕的 prompt：</label>
            <textarea id="textInput" rows="14" cols="60">
我将提供一篇的字幕文件，
以空行隔出很多段，
每段 3 行，分别表示：索引，时间线，字幕
例如：
2  # 表示 索引
00:00:02,554 --> 00:00:04,414  # 表示 时间线
快救救林晓 救救他呀  # 表示 字幕

你需要在这篇字幕中，选出重要的、关键的字幕段，注意一下几点：
1. 仅返回给我“索引”，不要有任何非索引内容出现
2. 忽略 &lt; No Speech &gt; 字幕
3. 你挑选出的索引条数，不要超过原字幕段数的四分之一；
</textarea>
        </div>
        <div class="section">
            <button id="uploadButton" onclick="uploadFiles()">上传</button>
            <button id="extractButton" onclick="extractContent()">抽取</button>
            <button id="viewResultButton" onclick="viewResult()">查看结果</button>
        </div>
        <div class="section" id="videoContainer"></div>
    </div>

    <script>
        let requestId = null;

        async function uploadFiles() {
            const files = document.getElementById('fileInput').files;
            const prompt = document.getElementById('textInput').value;
            if (files.length === 0 || !prompt) {
                alert('请先选择视频文件并填写文本内容');
                return;
            }

            const formData = new FormData();
            for (const file of files) {
                formData.append('files', file);
            }
            formData.append('prompt', prompt);

            const response = await fetch('/api/v1/upload', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                const result = await response.json();
                requestId = result.request_id;
                alert(`Files uploaded successfully. Request ID: ${requestId}`);
            } else {
                alert('上传失败');
            }
        }

        async function extractContent() {
            if (!requestId) {
                alert('请先上传文件');
                return;
            }

            try {
                const response = await fetch(`/api/v1/extract/${requestId}`);
                const data = await response.json();

                if (!response.ok) {
                    alert(`抽取失败，请重试: ${data.message}`);
                } else {
                    alert(`${data.message}`);
                }
            } catch (error) {
                alert('请求失败，请重试');
            }
        }

        async function viewResult() {
            if (!requestId) {
                alert('请先上传并抽取内容');
                return;
            }

            const videoUrl = `/static/videos/${requestId}/final.mp4`;
            const videoContainer = document.getElementById('videoContainer');

            videoContainer.innerHTML = `
                <video controls autoplay name="media" style="display: block;">
                    <source src="${videoUrl}" type="video/mp4">
                </video>
            `;
        }
    </script>
</body>
</html>
